stages:
  - test
  - report

# Переменные, которые можно переопределять через GitLab CI/CD Variables
variables:
  APP_ENV: "v29"        # версия окружения
  TEST_MARKER: ""       # метка тестов

# -----------------------------
# Job: Запуск тестов
# -----------------------------
run_tests:
  stage: test
  image: femtopixel/allure-pytest   # Docker образ с Python и Allure
  script:
    - pip install --upgrade pip
    - pip install -r requirement.txt
    # Запуск тестов с маркером (если TEST_MARKER пустой — все тесты)
    - if [ -z "$TEST_MARKER" ]; then pytest --alluredir=reports/allure-results; else pytest -m "$TEST_MARKER" --alluredir=reports/allure-results; fi
    # Генерация Allure HTML отчета
    - allure generate reports/allure-results -o reports/allure-report --clean
  artifacts:
    name: "allure-results-$CI_COMMIT_REF_NAME"
    paths:
      - reports/allure-results/
      - reports/allure-report/
    expire_in: 7 days
    when: always
  tags:
    - api

# -----------------------------
# Job: Публикация отчета через GitLab Pages
# -----------------------------
publish_report:
  stage: report
  dependencies:
    - run_tests
  script:
    # GitLab Pages требует папку public
    - mkdir -p public
    - cp -r reports/allure-report/* public/
  artifacts:
    paths:
      - public
  only:
    - main    # публикуем отчёт только из основной ветки

